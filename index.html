<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Elegant Code</title>
	<link rel="stylesheet" href="/css/style.css" />
	
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/archives" class="header__link">Archive</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Elegant Code</a></h1>
		<h2 class="header__subtitle">Getting better @ modern web dev</h2>
	</header>

	<main>
		



	<article>
	
		<h1><a href="/2017/03/20/Vanilla-Node-js-Web-Server-3/">Vanilla Node.js Web Server - 3</a></h1>
	
	<div class="article__infos">
		<span class="article__date">03-20-2017</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Crafting-vanilla-Node-js-web-server/">Crafting vanilla Node.js web server</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/node-js-web-server-es6-http-mime/">node.js, web server, es6, http, mime</a>
			</span>
		
	</div>

	

	
		<h2 id="THIS-POST-IS-NOT-COMPLETE"><a href="#THIS-POST-IS-NOT-COMPLETE" class="headerlink" title="! ! THIS POST IS NOT COMPLETE ! !"></a>! ! THIS POST IS NOT COMPLETE ! !</h2><p>I will be finishing during spring break 2017  </p>
<h4 id="JavaScript-Templating-amp-File-I-O"><a href="#JavaScript-Templating-amp-File-I-O" class="headerlink" title="JavaScript Templating &amp; File I/O"></a>JavaScript Templating &amp; File I/O</h4><p>After completing <a href="https://codeelegant.github.io/2017/03/16/Vanilla-Node-js-Webserver/">lesson 1</a>, &amp; <a href="https://codeelegant.github.io/2017/03/17/Vanilla-Node-js-Webserver-2/">lesson 2</a>, you have a web server that can serve static web pages on par with the very <em>excellent</em> <a href="https://www.npmjs.com/package/http-server" target="_blank" rel="external">http server</a>. WHAT!?!? You could have just used a library and had a canned web server without having to write all that code? Yes, itâ€™s true. Thatâ€™s not really why youâ€™re here though, is it? You are here to learn how to write code &amp; to understand JavaScript &amp; Node.js better.  </p>
<p>In this, the last lesson in the â€˜Vanilla Node.js web serverâ€™ series, we are going to tackle more dynamic functionality: Databases with <a href="https://github.com/louischatriot/nedb" target="_blank" rel="external">NeDB</a>, csv files, and html templating with <a href="http://www.embeddedjs.com/" target="_blank" rel="external">EJS</a>.<br><figure class="figure"><img src="/stuff/nedb_ejs.png" alt=""></figure><br>Why would you want to read/write data to a server? File I/O on the server using <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" target="_blank" rel="external">Ajax</a></strong> or the new <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank" rel="external">fetch</a></strong> API is the primary way (the <em>only</em> way I know ofâ€¦) to send data from the DOM to the server to permanently store the data. Then you can use your server-side JavaScript to do what you normally do with data: Query it, modify it, print it, sell it to spammers, etc. (please donâ€™t do that last one!).</p>
<p>Letâ€™s begin by making two (2) new directories in the root of our project called data &amp; node. Weâ€™ll keep our data files in the data folder and any of our Node.js scripts in the node folder - I know, â€˜duhâ€™â€¦.! When we are finished with this lesson weâ€™ll have a file named <strong>people.csv</strong> and a file named <strong>games.json</strong> in our data folder. In our node folder weâ€™ll have a file named <strong>Data_Handler.js</strong>.<br><figure class="figure"><img src="/stuff/capture3.png" alt="Like this"><figcaption class="figure__caption">Like this</figcaption></figure></p>
<p>In the views folder weâ€™ll want to have some ejs files, in the css folder throw in some styling, and in the javascripts folder, chuck in some client-side form handling capability. Weâ€™ll also have some client-side Ajax code in there so we can send the data over to the server code for processing. Feel free to look at my source code over on my <a href="https://github.com/CodeElegant/NodeWebServerLesson" target="_blank" rel="external">GitHub Repository</a>.</p>
<p>We will need to update our <strong>package.json</strong> file so that npm can install some library dependencies that weâ€™ll need for our project. Add dependencies for <strong>ejs</strong>, <strong>formidable</strong>, &amp; <strong>nedb</strong>. Your <strong>package.json</strong> should look like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"nodewebserverlesson"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"Demo Code"</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"bin/server"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"start"</span>: <span class="string">"node bin/server"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Howard Bates"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"ejs"</span>: <span class="string">"latest"</span>,</div><div class="line">    <span class="string">"formidable"</span>: <span class="string">"latest"</span>,</div><div class="line">    <span class="string">"nedb"</span>: <span class="string">"latest"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Check out that sweet, sweet JSON goodness with all the quotes, commas, and curly braces. Man, programming is weird. It must be universal in the galaxy though if that guy in <em>Independence Day</em> was able to upload a virus to the alien mothership. ;-P  (Yes, I know itâ€™s explained <a href="https://www.yahoo.com/movies/independence-day-producer-explains-hacking-scene-104676447332.html" target="_blank" rel="external">HERE</a>.)<br><figure class="figure"><img src="/stuff/virus.gif" alt=""></figure>  </p>
<p>Run the <strong>npm install</strong> command in your terminal. A folder called node_modules will be created and all the libraries/dependencies will be installed into it. The node_modules directory has a figginâ€™ TON of files in it, wayyy more than weâ€™d want to push/pull from GitHub. Whatâ€™s a Codesmith to do to stop this? Guess what, all you have to do is have the <strong>.ignore</strong> IntelliJ plugin installed and create a file in the root of your project named <strong>.gitignore</strong>. Each line of this file will contain all the stuff you donâ€™t want <strong>git</strong> to give a heck about. Just put <strong>node_modules</strong> in the top of your <strong>.gitignore</strong> file and viola!</p>
<p>First up with the extensions we want to add to our web app is Embedded JavaScript (EJS), which is a JavaScript templating engine. Why would you want to use a template engine anyway? See <strong><a href="https://www.smashingmagazine.com/2012/12/client-side-templating/" target="_blank" rel="external">this article</a></strong>, and watch <strong><a href="https://css-tricks.com/video-screencasts/127-basics-of-javascript-templating/" target="_blank" rel="external">this video</a></strong>. I wonâ€™t be showing you how to use the templating logical constructs in your HTML, just how to use templating for bolting on extra pages of data such as a header, footer, and pages of divs for hiding &amp; showing on demand.<br>At the top of the <strong>loadServer()</strong> method in your <strong>app.js</strong> file, create a constant that imports the <strong>EJS</strong> library like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> EJS = <span class="built_in">require</span>(<span class="string">'ejs'</span>);</div></pre></td></tr></table></figure>
<p>Change the way we handle some content types like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'css'</span>) &gt;= <span class="number">0</span> || contentType.indexOf(<span class="string">'js'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">	 response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">	 response.end(string, <span class="string">'utf-8'</span>);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'html'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">	 <span class="built_in">console</span>.log(<span class="string">`Rendering EJS`</span>);</div><div class="line">	 response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">	 response.end(EJS.render(string, &#123;</div><div class="line">		  <span class="attr">data</span>: <span class="keyword">this</span>.ejsData,</div><div class="line">		  <span class="attr">filename</span>: <span class="string">'index.ejs'</span></div><div class="line">	 &#125;));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Finally, change your root route to this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'/'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">	<span class="keyword">this</span>.render(<span class="string">'public/views/index.ejs'</span>, <span class="string">'text/html'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Your entire <strong>app.js</strong> should look like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// todo:</span></div><div class="line"><span class="meta"></span></div><div class="line">"use strict";</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">app</span> </span>&#123;</div><div class="line">     <span class="keyword">constructor</span>() &#123;</div><div class="line">          <span class="keyword">this</span>.ejsData = <span class="literal">null</span>;</div><div class="line">          <span class="keyword">this</span>.user = <span class="literal">null</span>;</div><div class="line">          <span class="keyword">this</span>.loadServer();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     loadServer() &#123;</div><div class="line">          <span class="keyword">const</span> HTTP = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line">          <span class="keyword">const</span> PORT = <span class="number">8005</span>;</div><div class="line">          <span class="keyword">const</span> EJS = <span class="built_in">require</span>(<span class="string">'ejs'</span>);</div><div class="line"></div><div class="line">          HTTP.createServer(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">               <span class="keyword">let</span> httpHandler = <span class="function">(<span class="params">error, string, contentType</span>) =&gt;</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (error) &#123;</div><div class="line">                         response.writeHead(<span class="number">500</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</div><div class="line">                         response.end(<span class="string">'An error has occurred: '</span> + error.message);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'css'</span>) &gt;= <span class="number">0</span> || contentType.indexOf(<span class="string">'js'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(string, <span class="string">'utf-8'</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'html'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(EJS.render(string, &#123;</div><div class="line">                              <span class="attr">data</span>: <span class="keyword">this</span>.ejsData,</div><div class="line">                              <span class="attr">filename</span>: <span class="string">'index.ejs'</span></div><div class="line">                         &#125;));</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(string, <span class="string">'binary'</span>);</div><div class="line">                    &#125;</div><div class="line">               &#125;;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.css'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'text/css'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.js'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'application/javascript'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.png'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'image/png'</span>, httpHandler, <span class="string">'binary'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'/'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(<span class="string">'public/views/index.ejs'</span>, <span class="string">'text/html'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">this</span>.render(<span class="string">`HEY! What you're looking for: It's not here!`</span>, <span class="string">'text/html'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">          &#125;).listen(PORT);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     render(path, contentType, callback, encoding) &#123;</div><div class="line">          <span class="keyword">const</span> FS = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line">          FS.readFile(path, encoding ? encoding : <span class="string">'utf-8'</span>, (error, string) =&gt; &#123;</div><div class="line">               callback(error, string, contentType);</div><div class="line">          &#125;);</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app;</div></pre></td></tr></table></figure></p>
<p>What does this extra code do? We really only added a library call, changed the name of the file we render from index.html to index.ejs, and called the <strong>render</strong> static method from the <strong>ejs</strong> library, which â€˜turns onâ€™ EJS capability. Read about it <a href="https://www.npmjs.com/package/ejs" target="_blank" rel="external">HERE</a>.</p>
<p>To do the page-bolt on technique I like so much, I simply created seperate header.ejs &amp; footer.ejs files with the top &amp; bottom parts of a normal html page. I then use this code in my index.ejs file where I want their contents to be displayed. (Remember to look at the GitHub repositry code). The line looks loke this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">public</span>/<span class="attr">views</span>/<span class="attr">header.ejs</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>To learn more about EJS, watch <a href="https://www.youtube.com/watch?v=BmmJujNQvXw" target="_blank" rel="external">THIS</a> video and read the documentation <a href="http://www.embeddedjs.com/getting_started.html" target="_blank" rel="external">HERE</a>. No, <strong><em>REALLY</em></strong> do it! I chose EJS to teach with because, although venerable, it is VERY easy to grok. It will make it much easier for you to jump into React, Vue, or Angular by learning this trivial templating engine.</p>
<h5 id="Exercise-time"><a href="#Exercise-time" class="headerlink" title="Exercise time!"></a>Exercise time!</h5><blockquote>
<p>Create a seperate html page with <em>only</em> a div of content. Use EJS tags in the index.ejs file to include the page you just made.</p>
</blockquote>
<h4 id="On-to-file-I-O"><a href="#On-to-file-I-O" class="headerlink" title="On to file I/O"></a>On to file I/O</h4><p>Now that we have some folders, letâ€™s modify our <strong>app.js</strong> file to handle POST requests. What the heck is a POST request? Well, if you look at the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" target="_blank" rel="external">MDN</a> youâ€™ll notice that there are a whole bunch of http request types. You will probably only work with GET &amp; POST 99.999% of the time. GET to get stuff from the server, and PUT to send stuff to the server, like filled-in form data.<br>I am going to cover two methods of file I/O. Reading/writing to .csv files using c-style for loops, and reading/writing to databases using NeDB.</p>
<p>We need to modify our <strong>app.js</strong> file to look like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// todo:</span></div><div class="line"><span class="meta"></span></div><div class="line">"use strict";</div><div class="line"></div><div class="line"><span class="keyword">const</span> DATA_HANDLER = <span class="built_in">require</span>(<span class="string">'./node/DataHandler'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">app</span> </span>&#123;</div><div class="line">     <span class="keyword">constructor</span>() &#123;</div><div class="line">          <span class="keyword">this</span>.ejsData = <span class="literal">null</span>;</div><div class="line">          <span class="keyword">this</span>.user = <span class="literal">null</span>;</div><div class="line">          <span class="keyword">this</span>.loadServer();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     loadServer() &#123;</div><div class="line">          <span class="keyword">const</span> HTTP = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line">          <span class="keyword">const</span> PORT = <span class="number">8005</span>;</div><div class="line">          <span class="keyword">const</span> EJS = <span class="built_in">require</span>(<span class="string">'ejs'</span>);</div><div class="line"></div><div class="line">          HTTP.createServer(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">               <span class="keyword">let</span> httpHandler = <span class="function">(<span class="params">error, string, contentType</span>) =&gt;</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (error) &#123;</div><div class="line">                         response.writeHead(<span class="number">500</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</div><div class="line">                         response.end(<span class="string">'An error has occurred: '</span> + error.message);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'css'</span>) &gt;= <span class="number">0</span> || contentType.indexOf(<span class="string">'js'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(string, <span class="string">'utf-8'</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType.indexOf(<span class="string">'html'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(EJS.render(string, &#123;</div><div class="line">                              <span class="attr">data</span>: <span class="keyword">this</span>.ejsData,</div><div class="line">                              <span class="attr">filename</span>: <span class="string">'index.ejs'</span></div><div class="line">                         &#125;));</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                         response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: contentType&#125;);</div><div class="line">                         response.end(string, <span class="string">'binary'</span>);</div><div class="line">                    &#125;</div><div class="line">               &#125;;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (request.method === <span class="string">'POST'</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (request.headers[<span class="string">'x-requested-with'</span>] === <span class="string">'XMLHttpRequest0'</span>) &#123;</div><div class="line">                         request.on(<span class="string">'data'</span>, (data) =&gt; &#123;</div><div class="line">                              <span class="keyword">this</span>.user = DATA_HANDLER.handleUserData(data.toString(<span class="string">'utf8'</span>));</div><div class="line">                              <span class="keyword">if</span> (<span class="keyword">this</span>.user !== <span class="string">'false'</span>) &#123;</div><div class="line">                                   response.writeHead(<span class="number">200</span>, &#123;<span class="string">'content-type'</span>: <span class="string">'application/json'</span>&#125;);</div><div class="line">                                   response.end(<span class="keyword">this</span>.user);</div><div class="line">                              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                   response.writeHead(<span class="number">200</span>, &#123;<span class="string">'content-type'</span>: <span class="string">'text/plain'</span>&#125;);</div><div class="line">                                   response.end(<span class="string">'false'</span>);</div><div class="line">                              &#125;</div><div class="line">                         &#125;);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                         response.writeHead(<span class="number">405</span>, <span class="string">"Method not supported"</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</div><div class="line">                         response.end(<span class="string">'&lt;html&gt;&lt;head&gt;&lt;title&gt;405 - Method not supported&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Method not supported.&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span>);</div><div class="line">                    &#125;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.css'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'text/css'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.js'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'application/javascript'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'.png'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(request.url.slice(<span class="number">1</span>), <span class="string">'image/png'</span>, httpHandler, <span class="string">'binary'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.url.indexOf(<span class="string">'/'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.render(<span class="string">'public/views/index.ejs'</span>, <span class="string">'text/html'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">this</span>.render(<span class="string">`HEY! What you're looking for: It's not here!`</span>, <span class="string">'text/html'</span>, httpHandler, <span class="string">'utf-8'</span>);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">          &#125;).listen(PORT);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     render(path, contentType, callback, encoding) &#123;</div><div class="line">          <span class="keyword">const</span> FS = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line">          FS.readFile(path, encoding ? encoding : <span class="string">'utf-8'</span>, (error, string) =&gt; &#123;</div><div class="line">               callback(error, string, contentType);</div><div class="line">          &#125;);</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app;</div></pre></td></tr></table></figure>
<p>Please note that weâ€™ve added a library import for our DataHandler.js class we will write. We also now have a POST handler section. We will use the client-side JavaScript to send the appropriate <strong>request.headers</strong> info so our app knows how to handle the client requests.</p>
<p>Now, write a separate class to handle the actual file I/0. Something like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//   todo:</span></div><div class="line"><span class="meta"></span></div><div class="line">"use strict";</div><div class="line"></div><div class="line"><span class="keyword">const</span> FS = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataHandler</span> </span>&#123;</div><div class="line"></div><div class="line">     <span class="keyword">static</span> handleUserData(data) &#123;</div><div class="line">          data = <span class="built_in">JSON</span>.parse(data);</div><div class="line">          <span class="keyword">const</span> FILE_PATH = <span class="string">'data/users.csv'</span>;</div><div class="line">          <span class="keyword">let</span> users = FS.readFileSync(FILE_PATH, <span class="string">'utf8'</span>);</div><div class="line">          <span class="keyword">let</span> user = &#123;&#125;;</div><div class="line">          <span class="keyword">const</span> COLUMNS = <span class="number">4</span>;</div><div class="line">          <span class="keyword">let</span> tempArray, finalData = [];</div><div class="line">          tempArray = users.split(<span class="regexp">/\r?\n/</span>); <span class="comment">//remove newlines</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tempArray.length; i++) &#123;</div><div class="line">               finalData[i] = tempArray[i].split(<span class="regexp">/,/</span>).slice(<span class="number">0</span>, COLUMNS);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalData.length; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (data === finalData[i][<span class="number">0</span>]) &#123;</div><div class="line">                    user = <span class="built_in">JSON</span>.stringify(&#123;</div><div class="line">                         <span class="string">'email'</span>: finalData[i][<span class="number">0</span>],</div><div class="line">                         <span class="string">'position'</span>: finalData[i][<span class="number">1</span>],</div><div class="line">                         <span class="string">'lastName'</span>: finalData[i][<span class="number">2</span>],</div><div class="line">                         <span class="string">'firstName'</span>: finalData[i][<span class="number">3</span>]</div><div class="line">                    &#125;);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    user = <span class="string">'false'</span>;</div><div class="line">               &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> user;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = DataHandler;</div></pre></td></tr></table></figure></p>
<p>You should see <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse" target="_blank" rel="external">JSON.parse()</a></strong> &amp; <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" target="_blank" rel="external">JSON.stringify()</a></strong> in the above code. If you peruse <a href="https://codeelegant.github.io/2017/03/16/Vanilla-Node-js-Webserver/">lesson 1</a>, youâ€™ll remember that all communication between the client DOM &amp; the server has to be string. Stringify takes object data &amp; turns it into a string to send, and parse unpacks the string back into its object form for use by the code. <a href="http://softwareengineering.stackexchange.com/questions/164094/why-does-javascript-use-json-stringify-instead-of-json-serialize" target="_blank" rel="external">Here</a> is a very good (but turbo-nerdy) explanation. All I am doing in the <strong>DataHandler.js</strong> class is accepting a userâ€™s email address, loading a user file from the hard drive into a multi-dimensional array, and comparing the email address submitted to finalData[i][0] column in the MD array loaded from the .csv file. If I find one, I return the entirety of the user data from the MD array to the DOM. If I donâ€™t have a match, I alert a message in the DOM stating they need to provide a valid email address. Easy-peasy, lemon-squeezy.  </p>
<p>I feel like we need an intermission here. How about a <a href="https://www.youtube.com/watch?v=wbM2_-JeDuY" target="_blank" rel="external">fantastic documentary</a> (Beware: some strong language in parts) about the Pink Floyd album <em>Wish you were here</em>? Yeah, I thought youâ€™d like that.  </p>
<p>Almost done with the csv part.</p>
<p>here are the contents of my <strong>users.csv</strong> file in my data folder:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bates4e@gmail.com,3rd Base,Bates,Howard</div><div class="line">meow@kitty.com,Left Field,Kitty,Hello</div></pre></td></tr></table></figure>
<p>The .csv file is the source of the hard drive data that we are iterating over to see if a user exists.</p>
<p>Finally, we have to have some client-side Ajax code so the DOM can yak at the server properly. Mine looks like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">performAjax(requestNum, sendToNode, callback) &#123;</div><div class="line">	<span class="keyword">let</span> bustCache = <span class="string">'?'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</div><div class="line">	<span class="keyword">const</span> XHR = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">	XHR.open(<span class="string">'POST'</span>, <span class="built_in">document</span>.url + bustCache, <span class="literal">true</span>);</div><div class="line">	XHR.setRequestHeader(<span class="string">'X-Requested-with'</span>, requestNum);</div><div class="line">	XHR.send(sendToNode);</div><div class="line">	XHR.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">		<span class="keyword">if</span> (XHR.readyState == <span class="number">4</span> &amp;&amp; XHR.status == <span class="number">200</span> &amp;&amp; callback) &#123;</div><div class="line">			<span class="keyword">return</span> callback(XHR.responseText);</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The magic happens with the <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" target="_blank" rel="external">XMLHttpRequest()</a></strong>. <em>THIS</em> is Ajax. Or Francis (just kidding).<br><figure class="figure"><img src="/stuff/deadpool.png" alt=""></figure><br>Remember, to see the whole code, look at the <strong>main.js</strong> file in the <a href="https://github.com/CodeElegant/NodeWebServerLesson" target="_blank" rel="external">GitHub repository</a>.  </p>
<p>The Ajax code allows us to open a POST request to the server, set the <strong>request.headers</strong>, send the data, then handle the response back from the server with the <strong>XHR.onload</strong> thingy. The <strong>app.js</strong> file receives &amp; handles the request with the <code>javascript if (request.method === &#39;POST&#39;) {}</code>section.  </p>
<p>It feels to me like Iâ€™ve gotten us into a â€˜How to draw an owlâ€™ situationâ€¦.<br><figure class="figure"><img src="/stuff/drawowl.jpg" alt=""></figure></p>
<p>Please make sure you REALLY understand how the Ajax method talks to the server, how the server responds, and how the Ajax method handles the response. Also, make sure you grok <strong>stringify</strong> &amp; <strong>parse</strong>, why we need them, &amp; how to use them. Use these resources:</p>
<ol>
<li><a href="https://www.sitepoint.com/guide-vanilla-ajax-without-jquery/" target="_blank" rel="external">Vanilla Ajax</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/AJAX/Getting_Started" target="_blank" rel="external">Ajax guide on MDN</a></li>
<li>A <a href="https://www.youtube.com/watch?v=qqRiDlm-SnY" target="_blank" rel="external">nice video</a></li>
<li>TutorialsPoint <a href="http://www.tutorialspoint.com/ajax/index.htm" target="_blank" rel="external">tutorial</a></li>
<li><a href="http://help.dottoro.com/ljspgwvf.php" target="_blank" rel="external">Ajax Reference Sheet</a></li>
</ol>
<p>You go through all of THAT material and you will be the <strong>Sensei of Ajax</strong> (feel free to put that on your rÃ©sumÃ©. Tell â€˜em I said so.)</p>
<h6 id="NeDB"><a href="#NeDB" class="headerlink" title="NeDB"></a>NeDB</h6><p>There is a lot of discussion about which database you should use for a web app. See <a href="https://blog.daftcode.pl/hype-driven-development-3469fc2e9b22#.ba7omm7fq" target="_blank" rel="external">here</a> &amp; <a href="https://blog.qmo.io/common-problems-when-developing-a-node-js-web-application/" target="_blank" rel="external">here</a> for discussions. SQL or NoSQL. Meh, for our purposes it doesnâ€™t matter, but for production it does matter, so get frosty on which database youâ€™ll need.</p>

	

	

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'https-codeelegant-github-io'; // required: replace example with your forum shortname
//		var disqus_developer = 1; // Comment out when the site is live
          var disqus_identifier = "{{ page.url }}";

		/* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>





	<span class="different-posts">ðŸ“– <a href="/page/2">more posts</a> ðŸ“–</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>Hi there, <br />welcome to my Blog glad you found it. Have a look around, will you?</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>Â© 2017 Howard Bates | Powered by <a href="https://hexo.io/">Hexo</a> | Theme <a href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>

	<div id="disqus_thread"></div>
	<script>

          /**
           *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
           *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
		 var disqus_config = function () {
		 this.page.url = https://codeelegant.github.io;  // Replace PAGE_URL with your page's canonical URL variable
		 this.page.identifier = CodeElegant; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		 };
          (function() { // DON'T EDIT BELOW THIS LINE
               var d = document, s = d.createElement('script');
               s.src = 'https://https-codeelegant-github-io.disqus.com/embed.js';
               s.setAttribute('data-timestamp', +new Date());
               (d.head || d.body).appendChild(s);
          })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</footer>



</body>

</html>
